#!/usr/bin/env bash
set -euo pipefail

repo="${SP_REPO_ROOT:-.}"
overlay=""
eid=""

usage() {
  cat <<'EOF'
Usage:
  spsnap-hash [--overlay NAME] [--eid N]

Outputs SHA-256 of the canonical TSV snapshot (derived view).
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --overlay) overlay="${2:?}"; shift 2;;
    --eid) eid="${2:?}"; shift 2;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2;;
  esac
done

tmp="$(mktemp)"
trap 'rm -f "$tmp"' EXIT

SP_REPO_ROOT="$repo" spsnap ${overlay:+--overlay "$overlay"} ${eid:+--eid "$eid"} --format tsv > "$tmp"
sha256sum "$tmp" | awk "{print \$1}"

