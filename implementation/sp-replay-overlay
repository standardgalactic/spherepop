#!/usr/bin/env bash
set -euo pipefail

leaf="${1:?overlay required}"
repo="${SP_REPO_ROOT:-.}"
base="$repo/.sp/log.tsv"
[[ -f "$base" ]] || { echo "Missing base log.tsv" >&2; exit 1; }

tmp="$(mktemp)"
trap 'rm -f "$tmp"' EXIT

cat "$base" > "$tmp"
SP_REPO_ROOT="$repo" sp-overlay-resolve "$leaf" >> "$tmp"

# sort by EID and replay
sort -n -k1,1 "$tmp" | sp-replay-stream

